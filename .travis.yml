language: node_js
node_js: "6"
dist: trusty
sudo: false
before_install:
    - export DISPLAY=:99.0
    - sh -e /etc/init.d/xvfb start
env:
  - ESHOST_TARGET=node
  - ESHOST_TARGET=firefox
  - ESHOST_TARGET=chakra
  - ESHOST_TARGET=jsshell
  - ESHOST_TARGET=chrome
  - ESHOST_TARGET=remote:firefox
  - ESHOST_TARGET=remote:edge
    SAUCE_USERNAME=jugglinmike
    ESHOST_REMOTE_WEBDRIVER_SERVER=https://$SAUCE_USERNAME:$SAUCE_ACCESS_KEY@ondemand.saucelabs.com/wd/hub
install: |
    export ESHOST_SKIP_D8=1
    export ESHOST_SKIP_JSC=1
    export ESHOST_SKIP_CHROME=1
    export ESHOST_SKIP_FIREFOX=1
    export ESHOST_SKIP_JSSHELL=1
    export ESHOST_SKIP_CH=1
    export ESHOST_SKIP_NODE=1
    export ESHOST_SKIP_REMOTE=1
    export ESHOST_SKIP_EDGE=1

    function install_firefox {
      export TMP=$(mktemp);
      wget https://archive.mozilla.org/pub/firefox/nightly/2017/07/2017-07-07-10-01-38-mozilla-central/firefox-56.0a1.en-US.linux-x86_64.tar.bz2 -O $TMP;
      tar -xvf $TMP;
      wget https://github.com/mozilla/geckodriver/releases/download/v0.17.0/geckodriver-v0.17.0-linux64.tar.gz -O $TMP;
      tar --directory firefox -xvf $TMP;
      rm $TMP;
      unset TMP;
    }

    if [[ "$ESHOST_TARGET" == "node" ]]; then
      unset ESHOST_SKIP_NODE;
    elif [[ "$ESHOST_TARGET" == "firefox" ]]; then
      install_firefox;
      export PATH=$(pwd)/firefox:$PATH;
      unset ESHOST_SKIP_FIREFOX;
    elif [[ "$ESHOST_TARGET" == "jsshell" ]]; then
      export TMP=$(mktemp);
      wget https://archive.mozilla.org/pub/firefox/nightly/2017/07/2017-07-07-10-01-38-mozilla-central/jsshell-linux-x86_64.zip -O $TMP;
      mkdir jsshell;
      unzip -d jsshell $TMP;
      rm $TMP;
      unset TMP;
      export PATH=$PATH:$(pwd)/jsshell;
      unset ESHOST_SKIP_JSSHELL;
    elif [[ "$ESHOST_TARGET" == "chakra" ]]; then
      wget https://aka.ms/chakracore/cc_linux_x64_1_5_2;
      tar -xvf cc_linux_x64_1_5_2;
      export PATH=$PATH:$(pwd)/ChakraCoreFiles/bin;
      unset ESHOST_SKIP_CH;
    elif [[ "$ESHOST_TARGET" == "chrome" ]]; then
      channel=unstable
      deb_archive=google-chrome-${channel}_current_amd64.deb
      wget https://dl.google.com/linux/direct/$deb_archive

      # If the environment provides an installation of Google Chrome, the
      # existing binary may take precedence over the one introduced in this
      # script. Remove any previously-existing "alternatives" prior to
      # installation in order to ensure that the new binary is installed as
      # intended.
      if sudo update-alternatives --list google-chrome; then
        sudo update-alternatives --remove-all google-chrome
      fi

      # Installation will fail in cases where the package has unmet dependencies.
      # When this occurs, attempt to use the system package manager to fetch the
      # required packages and retry.
      if ! sudo dpkg --install $deb_archive; then
        sudo apt-get install --fix-broken
        sudo dpkg --install $deb_archive
      fi

      mkdir chrome
      ln -s $(which google-chrome) chrome/chrome

      wget https://chromedriver.storage.googleapis.com/2.30/chromedriver_linux64.zip
      unzip -d chrome chromedriver_linux64.zip
      PATH=$PATH:$(pwd)/chrome
      unset ESHOST_SKIP_CHROME;
    elif [[ "$ESHOST_TARGET" == "remote:firefox" ]]; then
      install_firefox;
      wget http://selenium-release.storage.googleapis.com/3.4/selenium-server-standalone-3.4.0.jar
      PATH=$PATH:$(pwd)/firefox java -jar selenium-server-standalone-3.4.0.jar &> selenium-server.log &

      export ESHOST_REMOTE_BROWSERNAME=firefox
      export ESHOST_REMOTE_PLATFORM=ANY
      export ESHOST_REMOTE_VERSION=
      unset ESHOST_SKIP_REMOTE;
    elif [[ "$ESHOST_TARGET" == "remote:edge" ]]; then
      wget https://saucelabs.com/downloads/sc-4.4.8-linux.tar.gz
      tar -xvf sc-4.4.8-linux.tar.gz

      sc-4.4.8-linux/bin/sc \
        --logfile sauce-connect.log \
        --tunnel-domains eshost.test \
        --readyfile sauce-connect-ready &
      SC_PID="$!"

      echo "Waiting for Sauce Connect readyfile"
      while [ ! -f sauce-connect-ready ] && ps -f $SC_PID >&/dev/null; do
        sleep .5
      done

      if [ ! -f sauce-connect-ready ]; then
        echo "readyfile not created"
        exit 1;
      fi

      export ESHOST_REMOTE_BROWSERNAME=MicrosoftEdge
      export ESHOST_REMOTE_PLATFORM='Windows 10'
      export ESHOST_REMOTE_VERSION=15.15063
      unset ESHOST_SKIP_REMOTE;
    else
      exit 1;
    fi

    npm install
after_script: |
  if [[ "$ESHOST_TARGET" == "remote:firefox" ]]; then
    cat selenium-server.log
  fi

  if [[ "$ESHOST_TARGET" == "remote:edge" ]]; then
    cat sauce-connect.log
  fi
addons:
  hosts:
    - eshost.test
  # The "jwt" configuration was inserted by the `travis` executable in
  # response to the following command:
  #
  #     travis encrypt  --add addons.jwt SAUCE_ACCESS_KEY=VALUE
  #
  # ...where `VALUE` is the actual access key for the repository owner as
  # provided by Sauce Labs.
  jwt:
    secure: AlI/0fk8O8GE5gc0be7ya55Fqy/AxYANRzNcwgOrBNauBbpxKyyOKOqzLtkkd77wC18elUgAdUbVcyEIVP/BgIF4uQxIVEN9BcTO25UFdGXDyusxakBZvswDR4EsKz/r83HXZXp/Vep813zXPF3TK0s1hThI9VUtPOcufxWObi6ktwwkJDbwo7q1js4jwtCufawfG4loovj5YjX7YT6jod71mHLnVDx++yR5qhKuPArTr0edcZKSm1jJxK79iHYrz6LFv2VlQK/+sW6Zo3GXBoq0OdiMF6jDO35KvMlTFPIu9kX3YbDWs84AMC/7of6u5NhV/RXGoyAhYkF3LJJ6CsMZsEdYOkcuKSp7EoQogjrBgEAVV83IHWw9eTXvLknx2jgbnXdou11oMNSBpGWjo1vq5H4aohg4Nunz5bzOBbULIzxTIj0WrnVHrgNSuw0MoS/Mc12bf21Al+e6FDLExGzv5oCq0AhrLdH6tgNGX6lC9nWG/+hVCAefXgEou9CLRKCtYYAHSRhlYqtPQxITDSNmQIrSDy2I9kmA1TCtM2EEeltibRCYYkALK2ppBWqr0Pc3Ox7DhD8+tXBIBcvuNu/U7vnXA6WUui3XDD68m6x59sMA70utwrJ7pHokeXhe2wIp/lr9twOyOm+49/8+712o9+c9OiNC1ass5+eET50=
